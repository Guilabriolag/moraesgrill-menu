<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>McClone vBeta</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#DA291C">
<style>
:root {
  --color-primary: #FFCC00;
  --color-secondary: #DA291C;
  --bg: #fff;
  --font: 'Inter', sans-serif;
}
body {
  margin:0;
  font-family:var(--font);
  background:var(--bg);
  color:#333;
}
header {
  background:var(--color-secondary);
  color:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  user-select:none;
}
header h1 {
  margin:0;
  font-size:1.2rem;
  font-weight:bold;
}
button {
  padding:8px 16px;
  margin:4px 2px;
  border:none;
  border-radius:24px;
  cursor:pointer;
  font-weight:600;
  transition:all 0.2s ease-in-out;
}
button:hover {
  transform:translateY(-1px);
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.btn-primary {background:var(--color-primary);color:#000;}
.btn-secondary {background:var(--color-secondary);color:#fff;}
.btn-ghost {background:transparent;color:var(--color-secondary);border:1px solid var(--color-secondary);}
.btn-danger {background:#e53e3e;color:#fff;}
.input-field {
  width:calc(100% - 16px);
  padding:8px;
  margin:4px 0;
  border:1px solid #ccc;
  border-radius:8px;
}
.card-item {
  border:1px solid #ddd;
  border-radius:8px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  cursor:pointer;
  transition:transform 0.2s;
}
.card-item:hover {transform:scale(1.02);}
.card-item .thumb img {
  width:100%;
  height:120px;
  object-fit:cover;
}
.drawer {
  position:fixed;
  top:0;
  right:-320px;
  width:320px;
  height:100%;
  background:#fff;
  box-shadow:-2px 0 8px rgba(0,0,0,.3);
  transition:0.3s;
  padding:12px;
  overflow-y:auto;
  z-index:100;
}
.drawer.open {right:0;}
.screen {
  padding:12px;
  display:none;
}
.screen.active {
  display:block;
}
.small {font-size:0.75rem;color:#555;}
.kv {font-size:0.7rem;color:#999;}
.hr {border-top:1px solid #ccc;margin:6px 0;}
#cartFab {
  position:fixed;
  bottom:16px;
  right:16px;
  background:var(--color-primary);
  border-radius:50%;
  width:56px;
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  z-index:90;
}
#cartCount {
  position:absolute;
  top:-4px;
  right:-4px;
  background:red;
  color:#fff;
  border-radius:50%;
  width:20px;
  height:20px;
  font-size:0.7rem;
  display:flex;
  align-items:center;
  justify-content:center;
}
.tabs-container {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.tab-btn {
  padding:8px 16px;
  border-radius:24px;
  cursor:pointer;
  background:#eee;
}
.tab-btn.active {
  background:var(--color-secondary);
  color:#fff;
}
.tab-content {display:none;}
.tab-content.active {display:block;}
.table-data {
  width:100%;
  border-collapse:collapse;
  font-size:0.8rem;
  text-align:left;
}
.table-data th, .table-data td {
  border:1px solid #ccc;
  padding:6px;
}
.table-data th {
  background:#f0f0f0;
}
.toast {
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  padding:12px 24px;
  background:rgba(0,0,0,0.8);
  color:#fff;
  border-radius:24px;
  z-index:1000;
  opacity:0;
  transition:opacity 0.3s ease-in-out;
  pointer-events:none;
}
.toast.show {
  opacity:1;
}
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #4CAF50;
}
input:checked + .slider:before {
  transform: translateX(20px);
}
.filter-tabs {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 8px 0;
}
.filter-tab {
  white-space: nowrap;
  padding: 8px 12px;
  background: #f0f0f0;
  border-radius: 24px;
  cursor: pointer;
}
.filter-tab.active {
  background: var(--color-secondary);
  color: #fff;
}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

<header>
  <h1> vBeta</h1>
  <div id="userInfo"></div>
</header>

<main>
  <div id="loginScreen" class="screen active">
    <h2>Login</h2>
    <p class="small">Use 'DEVGUI' (admin) ou 'DEMO' (acesso restrito) com a senha 'DEMO'.</p>
    <input type="text" id="loginKey" placeholder="Key" class="input-field">
    <input type="password" id="loginPass" placeholder="Senha" class="input-field">
    <button class="btn-primary" onclick="login()">Entrar</button>
    <button class="btn-ghost" onclick="registerUser()">Cadastrar</button>
    <button class="btn-ghost" onclick="guestLogin()">Entrar como Visitante</button>
  </div>

  <div id="totemScreen" class="screen">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0;">CardÃ¡pio</h2>
      <button class="btn-ghost" onclick="toAdminPanel()" id="manageBtn" style="display:none;">Gerenciar</button>
    </div>
    <div id="categoryTabs" class="filter-tabs"></div>
    <div id="subcategoryTabs" class="filter-tabs" style="display:none;"></div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;padding:8px;" id="totemGrid"></div>
  </div>

  <div id="adminScreen" class="screen">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0;">Dashboard</h2>
      <button class="btn-ghost" onclick="toTotem()">Totem</button>
    </div>
    <div class="tabs-container" id="adminTabs"></div>
    <div id="tab-dashboard" class="tab-content">
      <h3>Resumo</h3>
      <div id="dashboardSummary"></div>
      <h3>Pedidos Recentes</h3>
      <div id="ordersList"></div>
    </div>
    <div id="tab-products" class="tab-content">
      <h3>Gerenciar Produtos</h3>
      <form id="prodForm">
        <input type="hidden" id="prodId">
        <input type="text" id="prodName" placeholder="Nome" class="input-field" required>
        <input type="number" id="prodPrice" placeholder="PreÃ§o" class="input-field" step="0.01" required>
        <div style="margin: 8px 0;">
            <input type="checkbox" id="isComboToggle" onchange="toggleComboFields()"> Ã‰ um Combo?
        </div>
        <div id="nonComboFields">
          <input type="text" id="prodCat" placeholder="Categoria" class="input-field">
          <input type="text" id="prodSubcat" placeholder="Subcategoria" class="input-field">
          <input type="number" id="prodStock" placeholder="Estoque" class="input-field" required>
        </div>
        <div id="comboFields" style="display:none;">
          <input type="text" id="comboItems" placeholder="IDs dos Itens do Combo (ex: id1,id2)" class="input-field">
          <div style="margin: 8px 0;">
            <input type="checkbox" id="isPromotionalToggle" onchange="togglePromoOptions()"> Ã‰ promocional?
          </div>
          <div id="promoOptions" style="display: none;">
            <label class="small">OpÃ§Ãµes de PromoÃ§Ã£o:</label><br>
            <input type="radio" id="promoType1" name="promoType" value="mais-caro" checked onchange="updatePromoPrice()">
            <label for="promoType1" class="small">Pagar apenas o produto mais caro</label><br>
            <input type="radio" id="promoType2" name="promoType" value="preco-fixo" onchange="updatePromoPrice()">
            <label for="promoType2" class="small">Escolher um preÃ§o para o combo</label><br>
          </div>
          <label class="small">Validade (em dias):</label>
          <input type="number" id="promoValidity" placeholder="Validade (dias)" class="input-field" value="0">
        </div>
        <input type="text" id="prodImg" placeholder="URL da imagem" class="input-field">
        <button type="submit" class="btn-primary">Salvar</button>
        <button type="button" class="btn-ghost" onclick="resetForm('prodForm')">Limpar</button>
      </form>
      <hr class="hr">
      <table class="table-data" id="prodTable"></table>
    </div>
    <div id="tab-people" class="tab-content">
      <h3>Gerenciar Pessoas</h3>
      <form id="personForm">
        <input type="hidden" id="personId">
        <input type="text" id="personName" placeholder="Nome" class="input-field">
        <input type="tel" id="personPhone" placeholder="Telefone" class="input-field">
        <button type="submit" class="btn-primary">Salvar</button>
        <button type="button" class="btn-ghost" onclick="resetForm('personForm')">Limpar</button>
      </form>
      <hr class="hr">
      <table class="table-data" id="peopleTable"></table>
    </div>
    <div id="tab-coupons" class="tab-content">
      <h3>Gerenciar Cupons</h3>
      <form id="couponForm">
        <input type="hidden" id="couponId">
        <input type="text" id="couponCode" placeholder="CÃ³digo" class="input-field">
        <input type="number" id="couponValue" placeholder="Valor (R$)" class="input-field" step="0.01">
        <button type="submit" class="btn-primary">Salvar</button>
        <button type="button" class="btn-ghost" onclick="resetForm('couponForm')">Limpar</button>
      </form>
      <hr class="hr">
      <table class="table-data" id="couponsTable"></table>
    </div>
    <div id="tab-ads" class="tab-content">
      <h3>Gerenciar Publicidade</h3>
      <form id="adsForm">
        <input type="hidden" id="adsId">
        <input type="text" id="adsContent" placeholder="ConteÃºdo do anÃºncio" class="input-field">
        <button type="submit" class="btn-primary">Salvar</button>
        <button type="button" class="btn-ghost" onclick="resetForm('adsForm')">Limpar</button>
      </form>
      <hr class="hr">
      <table class="table-data" id="adsTable"></table>
    </div>
    <div id="tab-keys" class="tab-content">
      <h3>Gerenciar Keys</h3>
      <form id="keyForm">
        <input type="hidden" id="keyId">
        <input type="text" id="keyKey" placeholder="Key" class="input-field">
        <input type="text" id="keyPass" placeholder="Senha" class="input-field">
        <select id="keyRole" class="input-field"></select>
        <button type="submit" class="btn-primary">Salvar</button>
        <button type="button" class="btn-ghost" onclick="resetForm('keyForm')">Limpar</button>
      </form>
      <hr class="hr">
      <table class="table-data" id="keysTable"></table>
    </div>
    <div id="tab-custom" class="tab-content">
      <h3>CustomizaÃ§Ã£o de Layout</h3>
      <div style="display:grid;gap:8px;">
        <div>
          <label for="customPrimary" class="small">Cor PrimÃ¡ria:</label>
          <input type="color" id="customPrimary" class="input-field">
        </div>
        <div>
          <label for="customSecondary" class="small">Cor SecundÃ¡ria:</label>
          <input type="color" id="customSecondary" class="input-field">
        </div>
        <div>
          <label for="customBg" class="small">Cor de Fundo:</label>
          <input type="color" id="customBg" class="input-field">
        </div>
        <button class="btn-primary" onclick="saveCustom()">Aplicar</button>
      </div>
    </div>
    <div id="tab-settings" class="tab-content">
      <h3>ConfiguraÃ§Ãµes e Dados</h3>
      <div>
        <label class="toggle-switch">
          <input type="checkbox" id="storeOpenToggle" onchange="toggleStoreStatus()">
          <span class="slider"></span>
        </label>
        <span id="storeStatusLabel">Loja Fechada</span>
      </div>
      <label for="waPhone" class="small">Telefone WhatsApp:</label>
      <input type="tel" id="waPhone" class="input-field">
      <button class="btn-primary" onclick="saveSetup()">Salvar</button>
      <hr class="hr">
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn-secondary" onclick="exportData()">Exportar Dados (JSON)</button>
        <label for="importFile" class="btn-ghost">Importar Dados (JSON)</label>
        <input type="file" id="importFile" style="display:none;" onchange="importData(event)">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        <button class="btn-danger" onclick="resetAllData()">Limpar Tudo</button>
      </div>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <h3>Carrinho</h3>
    <div id="cartItems" style="margin-bottom:12px;"></div>
    <div style="font-weight:bold;margin-top:12px;">Total: R$ <span id="cartSum">0.00</span></div>
    <button class="btn-primary" onclick="checkout()">Finalizar pedido</button>
    <button class="btn-ghost" onclick="clearCart()">Limpar</button>
    <button class="btn-ghost" onclick="toggleDrawer()">Fechar</button>
  </div>

  <div id="cartFab" onclick="toggleDrawer()">
    ðŸ›’
    <div id="cartCount">0</div>
  </div>
</main>
<div id="toast" class="toast"></div>

<script>
/* -------------------- Global State & Data Storage -------------------- */
const LS = {PRODS:'mcProds',PEOPLE:'mcPeople',COUPONS:'mcCoupons',KEYS:'mcKeys',CART:'mcCart',PUB:'mcPub',SETUP:'mcSetup',CUSTOM:'mcCustom',ORDERS:'mcOrders'};
const STATE = {
  user: null,
  products: [],
  people: [],
  coupons: [],
  keys: [],
  cart: { items: [] },
  pub: [],
  setup: { whatsapp: '', lastUpdate: null, storeOpen: true },
  custom: { primary: '#FFCC00', secondary: '#DA291C', bg: '#fff', font: 'Inter' },
  orders: [],
  undoHistory: [],
  undoPointer: -1,
  selectedCategory: 'Todos',
  selectedSubcategory: null
};

const KEY_LIMITS = {
  'A_DEVGUI': 1,
  'A_DEMO': 1,
  'B': 2,
  'C': 2,
  'D': 50
};
const ROLE_PERMISSIONS = {
  'A': ['A', 'B', 'C', 'D', 'E'],
  'B': ['B', 'C', 'D', 'E'],
  'C': ['D', 'E'],
  'D': [],
  'E': []
};
const ADMIN_TABS_CONFIG = {
  'dashboard': { name: 'Dashboard', role: ['A', 'B'] },
  'products': { name: 'ðŸ” Produtos', role: ['A', 'B'] },
  'people': { name: 'ðŸ‘¤ Pessoas', role: ['A', 'B'] },
  'coupons': { name: 'ðŸ·ï¸ Cupons', role: ['A', 'B'] },
  'ads': { name: 'ðŸ“¢ Publicidade', role: ['A', 'B'] },
  'keys': { name: 'ðŸ”‘ Keys', role: ['A', 'B', 'C'] },
  'custom': { name: 'ðŸŽ¨ Customizar', role: ['A', 'B'] },
  'settings': { name: 'âš™ï¸ Config', role: ['A', 'B'] },
};

/* -------------------- Utility Functions -------------------- */
function $(id) { return document.getElementById(id); }
function lsGet(k) { return JSON.parse(localStorage.getItem(k) || '[]'); }
function lsSet(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
function genId() { return Date.now(); }
function formatMoney(v) { return (v || 0).toFixed(2).replace('.', ','); }
function toast(msg) {
  const t = $('toast');
  t.innerText = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
function recordState() {
  if (STATE.undoPointer < STATE.undoHistory.length - 1) {
    STATE.undoHistory = STATE.undoHistory.slice(0, STATE.undoPointer + 1);
  }
  const newState = JSON.stringify({ products: STATE.products, people: STATE.people, coupons: STATE.coupons, keys: STATE.keys, orders: STATE.orders, setup: STATE.setup });
  STATE.undoHistory.push(newState);
  STATE.undoPointer = STATE.undoHistory.length - 1;
}
function undo() {
  if (STATE.undoPointer > 0) {
    STATE.undoPointer--;
    const prevState = JSON.parse(STATE.undoHistory[STATE.undoPointer]);
    STATE.products = prevState.products;
    STATE.people = prevState.people;
    STATE.coupons = prevState.coupons;
    STATE.keys = prevState.keys;
    STATE.orders = prevState.orders;
    STATE.setup = prevState.setup;
    saveAll();
    renderAllAdminTables();
    renderProducts();
    renderDashboard();
    toast('Ãšltima aÃ§Ã£o desfeita.');
  } else {
    toast('Nada para desfazer.');
  }
}
function canCreateKey(role) {
  if (!STATE.user) return false;
  const userRole = STATE.user.role;
  return ROLE_PERMISSIONS[userRole].includes(role);
}
function hasKeyLimitReached(role) {
  if (role === 'E') return false;
  const count = STATE.keys.filter(k => k.role === role).length;
  const keyType = (role === 'A') ? (STATE.keys.find(k => k.role === 'A' && k.key === 'DEVGUI') ? 'A_DEVGUI' : 'A_DEMO') : role;
  return count >= KEY_LIMITS[keyType];
}

/* -------------------- Initializers -------------------- */
document.addEventListener('DOMContentLoaded', () => {
  loadAll();
  applyCustomizations();
  if (window.location.hash === '#admin') {
    const devKey = STATE.keys.find(k => k.key === 'DEVGUI' && k.pass === '###*');
    if (devKey) {
      STATE.user = devKey;
      toAdminPanel();
    } else {
      toLogin();
    }
  } else {
    toLogin();
  }
  renderProducts();
  renderCart();
  renderSettings();
  renderCategories();
});

function loadAll() {
  STATE.products = lsGet(LS.PRODS);
  STATE.people = lsGet(LS.PEOPLE);
  STATE.coupons = lsGet(LS.COUPONS);
  STATE.keys = lsGet(LS.KEYS);
  STATE.cart = JSON.parse(localStorage.getItem(LS.CART) || '{"items":[]}');
  STATE.pub = lsGet(LS.PUB);
  STATE.setup = JSON.parse(localStorage.getItem(LS.SETUP) || '{"whatsapp":"", "storeOpen":true}');
  STATE.custom = JSON.parse(localStorage.getItem(LS.CUSTOM) || JSON.stringify(STATE.custom));
  STATE.orders = lsGet(LS.ORDERS);

  // Seed initial data if empty
  if (!STATE.keys.length) {
    STATE.keys.push({ id: genId(), key: 'DEVGUI', pass: '###*', role: 'A', active: true, unlimited: true });
    STATE.keys.push({ id: genId(), key: 'DEMO', pass: 'DEMO', role: 'A', active: true, unlimited: false });
  }
  if (!STATE.products.length) {
    STATE.products.push({ id: genId(), name: 'Cheeseburger', price: 15.00, cat: 'Lanches', subcat: 'SanduÃ­ches', stock: 10, img: 'https://via.placeholder.com/150/DA291C/FFFFFF?text=Cheeseburger', available: true, isCombo: false, isPromotional: false, promoType: null, promoValidity: 0, comboItems: [] });
    STATE.products.push({ id: genId(), name: 'Batata MÃ©dia', price: 8.00, cat: 'Acompanhamentos', subcat: 'Fritos', stock: 20, img: 'https://via.placeholder.com/150/FFCC00/000000?text=Batata', available: true, isCombo: false, isPromotional: false, promoType: null, promoValidity: 0, comboItems: [] });
    STATE.products.push({ id: genId(), name: 'Coca-Cola', price: 5.00, cat: 'Bebidas', subcat: 'Refrigerantes', stock: 30, img: 'https://via.placeholder.com/150/000000/FFFFFF?text=Coca-Cola', available: true, isCombo: false, isPromotional: false, promoType: null, promoValidity: 0, comboItems: [] });
  }
  saveAll();
}
function saveAll() {
  lsSet(LS.PRODS, STATE.products);
  lsSet(LS.PEOPLE, STATE.people);
  lsSet(LS.COUPONS, STATE.coupons);
  lsSet(LS.KEYS, STATE.keys);
  lsSet(LS.CART, STATE.cart);
  lsSet(LS.PUB, STATE.pub);
  lsSet(LS.SETUP, STATE.setup);
  lsSet(LS.CUSTOM, STATE.custom);
  lsSet(LS.ORDERS, STATE.orders);
}

/* -------------------- Screen & UI Rendering -------------------- */
function toLogin() { 
  switchScreen('loginScreen'); 
  $('userInfo').innerText = ''; 
  $('manageBtn').style.display = 'none';
}
function toTotem() { 
  switchScreen('totemScreen'); 
  if (STATE.user && (STATE.user.role === 'A' || STATE.user.role === 'B' || STATE.user.role === 'C')) {
    $('manageBtn').style.display = 'block';
  } else {
    $('manageBtn').style.display = 'none';
  }
}
function toAdminPanel() { 
  switchScreen('adminScreen'); 
  renderDashboard(); 
  renderAllAdminTables(); 
  renderAdminTabs();
}
function switchScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  $(screenId).classList.add('active');
  $('drawer').classList.remove('open');
}
function applyCustomizations() {
  document.documentElement.style.setProperty('--color-primary', STATE.custom.primary);
  document.documentElement.style.setProperty('--color-secondary', STATE.custom.secondary);
  document.documentElement.style.setProperty('--bg', STATE.custom.bg);
  document.documentElement.style.setProperty('--font', `'${STATE.custom.font}', sans-serif`);
  $('customPrimary').value = STATE.custom.primary;
  $('customSecondary').value = STATE.custom.secondary;
  $('customBg').value = STATE.custom.bg;
}
function saveCustom() {
  STATE.custom.primary = $('customPrimary').value;
  STATE.custom.secondary = $('customSecondary').value;
  STATE.custom.bg = $('customBg').value;
  applyCustomizations();
  lsSet(LS.CUSTOM, STATE.custom);
  toast('Tema salvo!');
}
function renderAdminTabs() {
  const tabsContainer = $('adminTabs');
  tabsContainer.innerHTML = '';
  const userRole = STATE.user ? STATE.user.role : null;
  
  let firstTab = null;

  for (const tabKey in ADMIN_TABS_CONFIG) {
    const config = ADMIN_TABS_CONFIG[tabKey];
    if (config.role.includes(userRole)) {
      const btn = document.createElement('button');
      btn.className = 'tab-btn';
      btn.dataset.tab = tabKey;
      btn.innerText = config.name;
      btn.onclick = () => {
        document.querySelectorAll('#adminTabs .tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        $(`tab-${tabKey}`).classList.add('active');
        if (tabKey === 'dashboard') renderDashboard();
      };
      tabsContainer.appendChild(btn);
      if (!firstTab) firstTab = btn;
    }
  }
  if (firstTab) {
    firstTab.classList.add('active');
    $(`tab-${firstTab.dataset.tab}`).classList.add('active');
  }
}

/* -------------------- Login & Permissions -------------------- */
function login() {
  const key = $('loginKey').value.trim();
  const pass = $('loginPass').value.trim();
  const k = STATE.keys.find(k => k.key === key && k.pass === pass && k.active);
  if (!k) { toast('Key invÃ¡lida'); return; }
  STATE.user = k;
  $('userInfo').innerText = `Logado: ${k.key} (${k.role})`;
  toTotem();
  toast('Login realizado!');
}

function registerUser() {
    if (hasKeyLimitReached('D')) {
        toast('Limite de chaves D atingido.');
        return;
    }
    const key = prompt('Escolha sua Key:');
    if (!key) { toast('OperaÃ§Ã£o cancelada.'); return; }
    if (STATE.keys.find(k => k.key === key)) {
        toast('Esta Key jÃ¡ existe.');
        return;
    }
    const pass = prompt('Escolha sua senha:');
    if (!pass) { toast('OperaÃ§Ã£o cancelada.'); return; }
    
    const newKey = { id: genId(), key, pass, role: 'D', active: true };
    STATE.keys.push(newKey);
    saveAll();
    toast('Cadastro realizado! Agora vocÃª pode logar.');
    $('loginKey').value = key;
    $('loginPass').value = pass;
}

function guestLogin() {
    const key = 'VISITANTE_' + Date.now().toString().slice(-4);
    const pass = 'guest';
    const newKey = { id: genId(), key, pass, role: 'E', active: true };
    STATE.keys.push(newKey);
    saveAll();
    STATE.user = newKey;
    $('userInfo').innerText = `Logado: ${key} (E)`;
    toTotem();
    toast('Acesso de visitante.');
}

/* -------------------- Totem & Cart -------------------- */
function renderCategories() {
  const categories = ['Todos', ...new Set(STATE.products.filter(p => !p.isCombo).map(p => p.cat))].filter(c => c);
  const catTabs = $('categoryTabs');
  catTabs.innerHTML = '';
  
  categories.forEach(cat => {
    const btn = document.createElement('div');
    btn.className = `filter-tab ${STATE.selectedCategory === cat ? 'active' : ''}`;
    btn.innerText = cat;
    btn.onclick = () => filterProducts(cat);
    catTabs.appendChild(btn);
  });
  
  if (STATE.selectedCategory && STATE.selectedCategory !== 'Todos') {
      renderSubcategories(STATE.selectedCategory);
  } else {
      $('subcategoryTabs').style.display = 'none';
  }

  renderProducts();
}
function renderSubcategories(category) {
    const subcats = ['Todos', ...new Set(STATE.products.filter(p => p.cat === category && !p.isCombo).map(p => p.subcat))].filter(sc => sc);
    const subcatTabs = $('subcategoryTabs');
    subcatTabs.innerHTML = '';

    if (subcats.length > 1) { // 1 because of 'Todos'
        subcatTabs.style.display = 'flex';
        subcats.forEach(subcat => {
            const btn = document.createElement('div');
            btn.className = `filter-tab ${STATE.selectedSubcategory === subcat ? 'active' : ''}`;
            btn.innerText = subcat;
            btn.onclick = () => filterProducts(category, subcat);
            subcatTabs.appendChild(btn);
        });
    } else {
        subcatTabs.style.display = 'none';
        STATE.selectedSubcategory = null;
    }
}
function filterProducts(category, subcategory = null) {
  STATE.selectedCategory = category;
  STATE.selectedSubcategory = subcategory;
  
  document.querySelectorAll('#categoryTabs .filter-tab').forEach(b => b.classList.remove('active'));
  document.querySelector(`#categoryTabs .filter-tab[data-category="${category}"]`)?.classList.add('active');

  if (category === 'Todos') {
    $('subcategoryTabs').style.display = 'none';
  } else {
    renderSubcategories(category);
  }
  renderProducts();
}
function renderProducts() {
  const grid = $('totemGrid');
  grid.innerHTML = '';
  
  let filteredProducts = STATE.products.filter(p => p.available);
  
  // Show all products and combos
  if (STATE.selectedCategory === 'Todos') {
    filteredProducts = STATE.products.filter(p => p.available);
  } else {
    // Filter by category and subcategory
    filteredProducts = filteredProducts.filter(p => p.cat === STATE.selectedCategory);
    if (STATE.selectedSubcategory && STATE.selectedSubcategory !== 'Todos') {
        filteredProducts = filteredProducts.filter(p => p.subcat === STATE.selectedSubcategory);
    }
  }

  filteredProducts.forEach((p) => {
    const div = document.createElement('div');
    div.className = 'card-item';
    div.onclick = () => addToCart(p.id);
    const comboInfo = p.isCombo ? ' Combo' : '';
    div.innerHTML = `<div class="thumb"><img src="${p.img}" alt="${p.name}"></div>
      <div style="padding:4px;font-weight:bold">${p.name}</div>
      <div style="padding:2px" class="small">R$ ${formatMoney(p.price)}${comboInfo}</div>
      <div style="padding:2px" class="kv">Estoque: ${p.isCombo ? '---' : p.stock}</div>`;
    grid.appendChild(div);
  });
}
function toggleDrawer() { $('drawer').classList.toggle('open'); }
function renderCart() {
  const list = $('cartItems');
  const countEl = $('cartCount');
  list.innerHTML = '';
  if (!STATE.cart.items.length) { list.innerHTML = '<div class="small">Carrinho vazio</div>'; countEl.innerText = '0'; $('cartSum').innerText = formatMoney(0); return; }
  let sum = 0;
  STATE.cart.items.forEach(i => {
    sum += i.price * i.qty;
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.margin = '4px 0';
    row.innerHTML = `<span>${i.qty}x ${i.pname}</span>
      <div>
        <button class="btn-ghost" onclick="changeCartQty(${i.id},-1)">-</button>
        <button class="btn-ghost" onclick="changeCartQty(${i.id},1)">+</button>
      </div>`;
    list.appendChild(row);
  });
  countEl.innerText = STATE.cart.items.reduce((s, i) => s + i.qty, 0);
  $('cartSum').innerText = formatMoney(sum);
  lsSet(LS.CART, STATE.cart);
}
function addToCart(id) {
  if (!STATE.setup.storeOpen && (STATE.user.role === 'D' || STATE.user.role === 'E')) {
    toast('Loja fechada. NÃ£o Ã© possÃ­vel adicionar itens ao carrinho no momento.');
    return;
  }
  
  const p = STATE.products.find(x => x.id == id); if (!p) return;
  if (p.isCombo) {
      const allItemsHaveStock = p.comboItems.every(itemId => {
          const item = STATE.products.find(prod => prod.id == itemId);
          return item && item.stock > 0;
      });
      if (!allItemsHaveStock) {
          toast(`Um ou mais itens do combo "${p.name}" estÃ£o fora de estoque.`);
          return;
      }
      p.comboItems.forEach(itemId => {
          const item = STATE.products.find(prod => prod.id == itemId);
          if (item) item.stock--;
      });
  } else if (p.stock <= 0) {
      toast(`${p.name} estÃ¡ fora de estoque.`);
      return;
  } else {
      p.stock--;
  }

  let item = STATE.cart.items.find(x => x.id == id);
  if (item) { item.qty++; } else { STATE.cart.items.push({ id, pname: p.name, price: p.price, qty: 1, isCombo: p.isCombo, comboItems: p.comboItems }); }
  
  renderCart();
  renderProducts();
  toast(`${p.name} adicionado!`);
}
function changeCartQty(id, ch) {
  let item = STATE.cart.items.find(x => x.id == id);
  if (!item) return;
  
  const p = STATE.products.find(x => x.id == id);
  if (!p) return;
  
  if (ch > 0 && p.isCombo) {
    const allItemsHaveStock = p.comboItems.every(itemId => {
        const item = STATE.products.find(prod => prod.id == itemId);
        return item && item.stock > 0;
    });
    if (!allItemsHaveStock) {
        toast(`Um ou mais itens do combo "${p.name}" estÃ£o fora de estoque.`);
        return;
    }
    p.comboItems.forEach(itemId => {
        const item = STATE.products.find(prod => prod.id == itemId);
        if (item) item.stock--;
    });
  } else if (ch > 0 && p.stock <= 0) {
    toast(`${p.name} estÃ¡ fora de estoque.`);
    return;
  } else if (!p.isCombo) {
      p.stock -= ch;
  }

  item.qty += ch;
  
  if (item.qty <= 0) {
      if (item.isCombo) {
        item.comboItems.forEach(itemId => {
            const indItem = STATE.products.find(prod => prod.id == itemId);
            if(indItem) indItem.stock += 1;
        });
      }
      STATE.cart.items = STATE.cart.items.filter(x => x.id != id);
  }
  
  renderCart();
  renderProducts();
}
function clearCart() {
  STATE.cart.items.forEach(item => {
    const p = STATE.products.find(x => x.id == item.id);
    if (!p) return;
    if (p.isCombo) {
        p.comboItems.forEach(itemId => {
            const indItem = STATE.products.find(prod => prod.id == itemId);
            if(indItem) indItem.stock += item.qty;
        });
    } else {
        p.stock += item.qty;
    }
  });
  STATE.cart.items = [];
  renderCart();
  renderProducts();
  toast('Carrinho limpo.');
}

/* -------------------- Checkout -------------------- */
function checkout() {
  if (!STATE.cart.items.length) { toast('Carrinho vazio'); return; }
  const phone = STATE.setup.whatsapp;
  if (!phone) { toast('WhatsApp nÃ£o configurado. Por favor, avise o gerente.'); return; }
  const name = prompt('Seu nome:');
  if (!name) { toast('Pedido cancelado.'); return; }
  
  const order = {
    id: genId(),
    date: new Date().toLocaleString(),
    name,
    items: STATE.cart.items,
    total: STATE.cart.items.reduce((s, i) => s + i.price * i.qty, 0)
  };
  
  STATE.orders.push(order);
  lsSet(LS.ORDERS, STATE.orders);
  
  let msg = `OlÃ¡! Novo pedido de *${name}*:\n\n`;
  order.items.forEach(i => { msg += `${i.qty}x ${i.pname} - R$ ${formatMoney(i.price * i.qty)}\n` });
  msg += `\nTotal do pedido: R$ ${formatMoney(order.total)}`;
  
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
  
  STATE.cart.items = [];
  renderCart();
  toast('Pedido enviado! Aguarde a confirmaÃ§Ã£o.');
}

/* -------------------- Admin Panel Management -------------------- */
function renderAllAdminTables() {
  renderProductsTable();
  renderPeopleTable();
  renderCouponsTable();
  renderAdsTable();
  renderKeysTable();
  renderKeyRoleOptions();
}

function renderDashboard() {
  const summaryEl = $('dashboardSummary');
  const ordersEl = $('ordersList');
  const totalSales = STATE.orders.reduce((s, o) => s + o.total, 0);
  const totalOrders = STATE.orders.length;
  const productSales = {};
  STATE.orders.forEach(o => o.items.forEach(i => {
    productSales[i.pname] = (productSales[i.pname] || 0) + i.qty;
  }));
  const topProduct = Object.keys(productSales).sort((a, b) => productSales[b] - productSales[a])[0] || 'N/A';
  
  summaryEl.innerHTML = `
    <p><strong>Total de Vendas:</strong> R$ ${formatMoney(totalSales)}</p>
    <p><strong>Total de Pedidos:</strong> ${totalOrders}</p>
    <p><strong>Produto Mais Vendido:</strong> ${topProduct} (${topProduct !== 'N/A' ? productSales[topProduct] : 0} unidades)</p>
  `;
  
  ordersEl.innerHTML = `
    <table class="table-data">
      <thead>
        <tr><th>ID</th><th>Data</th><th>Cliente</th><th>Total</th></tr>
      </thead>
      <tbody>
        ${STATE.orders.reverse().slice(0, 5).map(o => `<tr><td>${o.id}</td><td>${o.date.split(',')[0]}</td><td>${o.name}</td><td>R$ ${formatMoney(o.total)}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
}

// Products
function toggleComboFields() {
    const isCombo = $('isComboToggle').checked;
    $('nonComboFields').style.display = isCombo ? 'none' : 'block';
    $('comboFields').style.display = isCombo ? 'block' : 'none';

    $('prodPrice').required = isCombo ? false : true;
    $('prodCat').required = isCombo ? false : true;
    $('prodStock').required = isCombo ? false : true;
    $('comboItems').required = isCombo ? true : false;

    // Reset promo fields when toggling combo
    $('isPromotionalToggle').checked = false;
    togglePromoOptions();
}

function togglePromoOptions() {
  const isPromotional = $('isPromotionalToggle').checked;
  const isCombo = $('isComboToggle').checked;
  
  if (!isCombo) {
    $('promoOptions').style.display = 'none';
    $('promoValidity').style.display = 'none';
    $('isPromotionalToggle').checked = false;
    return;
  }

  $('promoOptions').style.display = isPromotional ? 'block' : 'none';
  $('promoValidity').style.display = isPromotional ? 'block' : 'none';

  if (isPromotional) {
    const promoType = document.querySelector('input[name="promoType"]:checked').value;
    if (promoType === 'mais-caro') {
      $('prodPrice').required = false;
      updatePromoPrice();
    } else {
      $('prodPrice').required = true;
    }
  } else {
    $('prodPrice').required = true;
  }
}

function updatePromoPrice() {
  const promoType = document.querySelector('input[name="promoType"]:checked').value;
  const priceInput = $('prodPrice');
  
  if (promoType === 'mais-caro') {
    const comboItems = $('comboItems').value.split(',').map(item => parseInt(item.trim()));
    const prices = comboItems.map(itemId => {
      const item = STATE.products.find(p => p.id === itemId);
      return item ? item.price : 0;
    });
    const maxPrice = Math.max(...prices);
    priceInput.value = maxPrice;
    priceInput.readOnly = true;
  } else {
    priceInput.readOnly = false;
  }
}

document.querySelectorAll('input[name="promoType"]').forEach(radio => {
  radio.addEventListener('change', updatePromoPrice);
});
$('comboItems').addEventListener('input', updatePromoPrice);

$('prodForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = $('prodId').value;
  const name = $('prodName').value;
  const isCombo = $('isComboToggle').checked;
  
  let price, cat, subcat, stock, comboItems, img, isPromotional, promoType, promoValidity;

  if (isCombo) {
    comboItems = $('comboItems').value.split(',').map(item => parseInt(item.trim()));
    if (comboItems.length < 2) {
      toast('Um combo deve ter pelo menos 2 produtos.');
      return;
    }
    cat = 'Combos';
    subcat = '';
    stock = 999;
    img = $('prodImg').value || 'https://via.placeholder.com/150/DA291C/FFFFFF?text=Combo';
    isPromotional = $('isPromotionalToggle').checked;
    promoType = isPromotional ? document.querySelector('input[name="promoType"]:checked').value : null;
    promoValidity = isPromotional ? parseInt($('promoValidity').value) : 0;
    price = parseFloat($('prodPrice').value);
  } else {
    price = parseFloat($('prodPrice').value);
    cat = $('prodCat').value;
    subcat = $('prodSubcat').value;
    stock = parseInt($('prodStock').value);
    comboItems = [];
    img = $('prodImg').value || 'https://via.placeholder.com/150';
    isPromotional = false;
    promoType = null;
    promoValidity = 0;
  }
  
  const newItem = { 
    id: id ? parseInt(id) : genId(), 
    name, 
    price, 
    cat, 
    subcat, 
    stock, 
    img, 
    available: true, 
    isCombo, 
    isPromotional, 
    promoType, 
    promoValidity, 
    comboItems 
  };
  
  if (id) {
    const prodIndex = STATE.products.findIndex(p => p.id == id);
    if (prodIndex !== -1) {
      STATE.products[prodIndex] = newItem;
      toast('Produto atualizado!');
    }
  } else {
    STATE.products.push(newItem);
    toast('Produto adicionado!');
  }
  recordState();
  saveAll();
  resetForm('prodForm');
  renderProductsTable();
  renderProducts();
  renderCategories();
});

function renderProductsTable() {
  const table = $('prodTable');
  table.innerHTML = `<thead><tr><th>ID</th><th>Nome</th><th>PreÃ§o</th><th>Cat</th><th>Subcat</th><th>Estoque</th><th>Combo</th><th>Promo</th><th>AÃ§Ãµes</th></tr></thead><tbody>
    ${STATE.products.map(p => {
        const comboInfo = p.isCombo ? `SIM (${p.comboItems.join(', ')})` : 'NÃƒO';
        const promoInfo = p.isPromotional ? `SIM (${p.promoType})` : 'NÃƒO';
        return `<tr><td>${p.id}</td><td>${p.name}</td><td>R$ ${formatMoney(p.price)}</td><td>${p.cat || 'N/A'}</td><td>${p.subcat || 'N/A'}</td><td>${p.isCombo ? '---' : p.stock}</td><td>${comboInfo}</td><td>${promoInfo}</td>
      <td><button class="btn-ghost" onclick="editItem('products', ${p.id})">Editar</button>
      <button class="btn-danger" onclick="deleteItem('products', ${p.id})">Del</button></td></tr>`;
    }).join('')}
  </tbody>`;
}

// People
$('personForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = $('personId').value;
  const name = $('personName').value;
  const phone = $('personPhone').value;
  if (id) {
    const p = STATE.people.find(x => x.id == id);
    if (p) { p.name = name; p.phone = phone; toast('Pessoa atualizada!'); }
  } else {
    STATE.people.push({ id: genId(), name, phone });
    toast('Pessoa adicionada!');
  }
  recordState();
  saveAll();
  resetForm('personForm');
  renderPeopleTable();
});
function renderPeopleTable() {
  const table = $('peopleTable');
  table.innerHTML = `<thead><tr><th>ID</th><th>Nome</th><th>Telefone</th><th>AÃ§Ãµes</th></tr></thead><tbody>
    ${STATE.people.map(p => `<tr><td>${p.id}</td><td>${p.name}</td><td>${p.phone}</td>
      <td><button class="btn-ghost" onclick="editItem('people', ${p.id})">Editar</button>
      <button class="btn-danger" onclick="deleteItem('people', ${p.id})">Del</button></td></tr>`).join('')}
  </tbody>`;
}

// Coupons
$('couponForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = $('couponId').value;
  const code = $('couponCode').value;
  const value = parseFloat($('couponValue').value);
  if (id) {
    const c = STATE.coupons.find(x => x.id == id);
    if (c) { c.code = code; c.value = value; toast('Cupom atualizado!'); }
  } else {
    STATE.coupons.push({ id: genId(), code, value, active: true });
    toast('Cupom adicionado!');
  }
  recordState();
  saveAll();
  resetForm('couponForm');
  renderCouponsTable();
});
function renderCouponsTable() {
  const table = $('couponsTable');
  table.innerHTML = `<thead><tr><th>ID</th><th>CÃ³digo</th><th>Valor</th><th>AÃ§Ãµes</th></tr></thead><tbody>
    ${STATE.coupons.map(c => `<tr><td>${c.id}</td><td>${c.code}</td><td>R$ ${formatMoney(c.value)}</td>
      <td><button class="btn-ghost" onclick="editItem('coupons', ${c.id})">Editar</button>
      <button class="btn-danger" onclick="deleteItem('coupons', ${c.id})">Del</button></td></tr>`).join('')}
  </tbody>`;
}

// Ads
$('adsForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = $('adsId').value;
  const content = $('adsContent').value;
  if (id) {
    const a = STATE.pub.find(x => x.id == id);
    if (a) { a.content = content; toast('AnÃºncio atualizado!'); }
  } else {
    STATE.pub.push({ id: genId(), content });
    toast('AnÃºncio adicionado!');
  }
  recordState();
  saveAll();
  resetForm('adsForm');
  renderAdsTable();
});
function renderAdsTable() {
  const table = $('adsTable');
  table.innerHTML = `<thead><tr><th>ID</th><th>ConteÃºdo</th><th>AÃ§Ãµes</th></tr></thead><tbody>
    ${STATE.pub.map(a => `<tr><td>${a.id}</td><td>${a.content}</td>
      <td><button class="btn-ghost" onclick="editItem('ads', ${a.id})">Editar</button>
      <button class="btn-danger" onclick="deleteItem('ads', ${a.id})">Del</button></td></tr>`).join('')}
  </tbody>`;
}

// Keys
function renderKeyRoleOptions() {
  const select = $('keyRole');
  select.innerHTML = '';
  const allowedRoles = ROLE_PERMISSIONS[STATE.user.role];
  allowedRoles.forEach(role => {
    if (role === 'A' && !STATE.user.unlimited) return;
    const option = document.createElement('option');
    option.value = role;
    option.innerText = `Tipo ${role}`;
    select.appendChild(option);
  });
}
$('keyForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = $('keyId').value;
  const key = $('keyKey').value;
  const pass = $('keyPass').value;
  const role = $('keyRole').value;

  if (hasKeyLimitReached(role)) {
    toast(`Limite de chaves tipo ${role} atingido.`);
    return;
  }
  if (!canCreateKey(role)) {
    toast(`Sua chave nÃ£o tem permissÃ£o para criar chaves tipo ${role}.`);
    return;
  }

  if (id) {
    const k = STATE.keys.find(x => x.id == id);
    if (k) { k.key = key; k.pass = pass; k.role = role; toast('Key atualizada!'); }
  } else {
    STATE.keys.push({ id: genId(), key, pass, role, active: true });
    toast('Key adicionada!');
  }
  recordState();
  saveAll();
  resetForm('keyForm');
  renderKeysTable();
});
function renderKeysTable() {
  const table = $('keysTable');
  table.innerHTML = `<thead><tr><th>ID</th><th>Key</th><th>FunÃ§Ã£o</th><th>Ativa</th><th>AÃ§Ãµes</th></tr></thead><tbody>
    ${STATE.keys.map(k => `<tr><td>${k.id}</td><td>${k.key}</td><td>${k.role}</td><td>${k.active ? 'Sim' : 'NÃ£o'}</td>
      <td><button class="btn-ghost" onclick="editItem('keys', ${k.id})">Editar</button>
      <button class="btn-danger" onclick="deleteItem('keys', ${k.id})">Del</button></td></tr>`).join('')}
  </tbody>`;
}

// General Edit/Delete
function editItem(entity, id) {
  const item = STATE[entity].find(x => x.id == id);
  if (!item) return;
  const form = document.forms[`${entity.slice(0, -1)}Form`];
  if (!form) return;
  
  form.querySelector('input[type="hidden"]').value = item.id;
  
  if (entity === 'products') {
    $('isComboToggle').checked = item.isCombo;
    $('isPromotionalToggle').checked = item.isPromotional;
    if (item.isPromotional) {
      document.querySelector(`input[name="promoType"][value="${item.promoType}"]`).checked = true;
      $('promoValidity').value = item.promoValidity;
    }
    
    if (item.isCombo) {
      $('comboItems').value = item.comboItems.join(', ');
      $('prodPrice').value = item.price;
      $('prodCat').value = '';
      $('prodSubcat').value = '';
      $('prodStock').value = '';
    } else {
      $('prodCat').value = item.cat || '';
      $('prodSubcat').value = item.subcat || '';
      $('prodStock').value = item.stock;
      $('prodPrice').value = item.price;
      $('comboItems').value = '';
    }
    
    $('prodName').value = item.name;
    $('prodImg').value = item.img || '';

    toggleComboFields();
    togglePromoOptions();
    updatePromoPrice();
    
  } else {
    for (const key in item) {
      const input = form.querySelector(`#${entity.slice(0, -1)}${key.charAt(0).toUpperCase() + key.slice(1)}`);
      if (input) {
        if (input.type === 'checkbox') {
            input.checked = item[key];
        } else if (Array.isArray(item[key])) {
            input.value = item[key].join(', ');
        } else {
            input.value = item[key] || '';
        }
      }
    }
  }
  
  toast('Item carregado para ediÃ§Ã£o.');
}
function deleteItem(entity, id) {
  if (confirm('Tem certeza?')) {
    STATE[entity] = STATE[entity].filter(x => x.id != id);
    saveAll();
    renderAllAdminTables();
    renderProducts();
    renderCategories();
    recordState();
    toast('Item excluÃ­do!');
  }
}
function resetForm(formId) {
  const form = $(formId);
  form.reset();
  form.querySelector('input[type="hidden"]').value = '';
  if (formId === 'prodForm') {
    $('isComboToggle').checked = false;
    $('isPromotionalToggle').checked = false;
    toggleComboFields();
    togglePromoOptions();
  }
}

// Settings
function renderSettings() {
  $('waPhone').value = STATE.setup.whatsapp;
  $('storeOpenToggle').checked = STATE.setup.storeOpen;
  $('storeStatusLabel').innerText = STATE.setup.storeOpen ? 'Loja Aberta' : 'Loja Fechada';
}
function toggleStoreStatus() {
  STATE.setup.storeOpen = !STATE.setup.storeOpen;
  $('storeStatusLabel').innerText = STATE.setup.storeOpen ? 'Loja Aberta' : 'Loja Fechada';
  saveAll();
  recordState();
  toast(`Loja agora estÃ¡ ${STATE.setup.storeOpen ? 'aberta' : 'fechada'}.`);
}
function saveSetup() {
  STATE.setup.whatsapp = $('waPhone').value;
  lsSet(LS.SETUP, STATE.setup);
  toast('ConfiguraÃ§Ãµes salvas!');
}

// Data Export/Import
function exportData() {
  const data = JSON.stringify(STATE, (key, value) => {
      // Exclude temporary/runtime data from export
      if (key === 'undoHistory' || key === 'undoPointer' || key === 'user') {
          return undefined;
      }
      return value;
  }, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `mcclone_data_${new Date().toISOString()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Dados exportados!');
}
function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const importedState = JSON.parse(e.target.result);
      if (confirm('Importar? Isso substituirÃ¡ todos os dados atuais.')) {
        for (const key in importedState) {
          if (STATE.hasOwnProperty(key) && key !== 'user' && key !== 'undoHistory' && key !== 'undoPointer') {
            STATE[key] = importedState[key];
          }
        }
        saveAll();
        loadAll(); 
        toast('Dados importados com sucesso!');
        toAdminPanel();
      }
    } catch (error) {
      toast('Erro ao importar. Arquivo JSON invÃ¡lido.');
    }
  };
  reader.readAsText(file);
}
function resetAllData() {
  if (confirm('Tem certeza que quer limpar TUDO?')) {
    localStorage.clear();
    location.reload();
  }
}

// Global Shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if ($('drawer').classList.contains('open')) {
      toggleDrawer();
    }
  }
  if (e.ctrlKey && e.key === 'z') {
    e.preventDefault();
    undo();
  }
  if (e.key === 'F11') {
    e.preventDefault();
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }
});
</script>

</body>
</html>
